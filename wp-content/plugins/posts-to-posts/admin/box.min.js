(function(){var k,n,p,d,q,r,s,t,l,m,h;h=function(a){return a.find(".p2p-icon").css("background-image","url("+P2PAdminL10n.spinner+")")};m=function(a){var b;b=a.closest("table");a.closest("tr").remove();if(!b.find("tbody tr").length)return b.hide()};l=function(a){return jQuery("#p2p-template-"+a).html()};k=Backbone.Model.extend({});d=Backbone.Model.extend({});n=Backbone.Model.extend({sync:function(){var a=this;return this.ajax_request({subaction:"search"},function(b){var c;a.total_pages=(null!=(c=
b.navigation)?c["total-pages-raw"]:void 0)||1;return a.trigger("sync",b)})},validate:function(a){var b;return 0<(b=a.paged)&&b<=this.total_pages?null:"invalid page"}});q=Backbone.Collection.extend({model:d,createItemAndConnect:function(a){var b=this;return this.ajax_request({subaction:"create_post",post_title:a},function(a){return b.trigger("create",a)})},create:function(a){var b=this;a={subaction:"connect",to:a.get("id")};return this.ajax_request(a,function(a){return b.trigger("create",a)})},"delete":function(a){var b,
c=this;b={subaction:"disconnect",p2p_id:a.get("id")};return this.ajax_request(b,function(b){return c.trigger("delete",b,a)})},clear:function(){var a=this;return this.ajax_request({subaction:"clear_connections"},function(b){return a.trigger("clear",b)})}});r=Backbone.View.extend({events:{"click th.p2p-col-delete .p2p-icon":"clear","click td.p2p-col-delete .p2p-icon":"delete"},initialize:function(a){this.maybe_make_sortable();this.collection.on("create",this.afterCreate,this);return this.collection.on("clear",
this.afterClear,this)},maybe_make_sortable:function(){if(this.$("th.p2p-col-order").length)return this.$("tbody").sortable({handle:"td.p2p-col-order",helper:function(a,b){b.children().each(function(){var a;a=jQuery(this);return a.width(a.width())});return b}})},clear:function(a){a.preventDefault();if(confirm(P2PAdminL10n.deleteConfirmMessage))return a=jQuery(a.target).closest("td"),h(a),this.collection.clear()},afterClear:function(){return this.$el.hide().find("tbody").html("")},"delete":function(a){var b;
a.preventDefault();b=jQuery(a.target).closest("td");h(b);this.collection["delete"](new d({id:b.find("input").val()})).done(function(){return m(b)});return null},afterCreate:function(a){this.$el.show().find("tbody").append(a.row);return this.collection.trigger("append",a)}});p=Backbone.View.extend({template:Mustache.compile(l("tab-list")),events:{"keypress :text":"handleReturn","keyup :text":"handleSearch","click .p2p-prev, .p2p-next":"changePage","click td.p2p-col-create div":"promote"},initialize:function(a){this.spinner=
a.spinner;a.connections.on("delete",this.afterCandidatesRefreshed,this);a.connections.on("clear",this.afterCandidatesRefreshed,this);this.collection.on("sync",this.afterCandidatesRefreshed,this);this.collection.on("error",this.afterInvalid,this);return this.collection.on("invalid",this.afterInvalid,this)},promote:function(a){var b,c=this;a.preventDefault();b=jQuery(a.target).closest("td");h(b);this.options.connections.create(new k({id:b.find("div").data("item-id")})).done(function(){return c.options.duplicate_connections?
b.find(".p2p-icon").css("background-image",""):m(b)});return null},handleReturn:function(a){13===a.keyCode&&a.preventDefault();return null},handleSearch:function(a){var b,c,e=this;void 0!==c&&clearTimeout(c);b=jQuery(a.target);c=setTimeout(function(){var a;a=b.val();if(a!==e.collection.get("s"))return e.spinner.insertAfter(e.searchInput).show(),e.collection.save({s:a,paged:1})},400);return null},changePage:function(a){var b;a=jQuery(a.currentTarget);b=this.collection.get("paged");a.hasClass("p2p-prev")?
b--:b++;this.spinner.appendTo(this.$(".p2p-navigation"));return this.collection.save("paged",b)},afterCandidatesRefreshed:function(a){this.spinner.remove();this.$("button, .p2p-results, .p2p-navigation, .p2p-notice").remove();"string"!==typeof a&&(a=this.template(a));return this.$el.append(a)},afterInvalid:function(){return this.spinner.remove()}});s=Backbone.View.extend({events:{"click button":"createItem","keypress :text":"handleReturn"},initialize:function(a){this.createButton=this.$("button");
return this.createInput=this.$(":text")},handleReturn:function(a){13===a.keyCode&&(this.createButton.click(),a.preventDefault());return null},createItem:function(a){var b=this;a.preventDefault();if(this.createButton.hasClass("inactive"))return!1;a=this.createInput.val();if(""===a)this.createInput.focus();else return this.createButton.addClass("inactive"),a=this.collection.createItemAndConnect(a),a.done(function(){b.createInput.val("");return b.createButton.removeClass("inactive")}),null}});t=Backbone.View.extend({events:{"click .p2p-toggle-tabs":"toggleTabs",
"click .wp-tab-bar li":"setActiveTab"},initialize:function(a){this.spinner=a.spinner;this.initializedCandidates=!1;a.connections.on("append",this.afterConnectionAppended,this);a.connections.on("clear",this.afterConnectionDeleted,this);return a.connections.on("delete",this.afterConnectionDeleted,this)},toggleTabs:function(a){a.preventDefault();a=this.$(".p2p-create-connections-tabs");a.toggle();!this.initializedCandidates&&a.is(":visible")&&(this.options.candidates.sync(),this.initializedCandidates=
!0);return null},setActiveTab:function(a){a.preventDefault();a=jQuery(a.currentTarget);this.$(".wp-tab-bar li").removeClass("wp-tab-active");a.addClass("wp-tab-active");return this.$el.find(".tabs-panel").hide().end().find(a.data("ref")).show().find(":text").focus()},afterConnectionAppended:function(a){if("one"===this.options.cardinality)return this.$(".p2p-create-connections").hide()},afterConnectionDeleted:function(a){if("one"===this.options.cardinality)return this.$(".p2p-create-connections").show()}});
window.P2PAdmin={Candidate:k,Connection:d,boxes:{}};jQuery(function(){var a;jQuery('<input placeholder="1" />')[0].placeholder||(a=function(){var a;a=jQuery(this);a.val()||(a.val(a.attr("placeholder")),a.addClass("p2p-placeholder"))},jQuery(".p2p-search input[placeholder]").each(a).focus(function(){var a;a=jQuery(this);a.hasClass("p2p-placeholder")&&(a.val(""),a.removeClass("p2p-placeholder"))}).blur(a));Mustache.compilePartial("table-row",l("table-row"));return jQuery(".p2p-box").each(function(){var a,
c,e,f,g,d;a=jQuery(this);c=jQuery("<img>",{src:P2PAdminL10n.spinner,"class":"p2p-spinner"});f=new n({s:"",paged:1});f.total_pages=a.find(".p2p-total").data("num")||1;d={p2p_type:a.data("p2p_type"),direction:a.data("direction"),from:jQuery("#post_ID").val()};e=function(a,b){var c;c=_.extend({},a,f.attributes,d,{action:"p2p_box",nonce:P2PAdminL10n.nonce});return jQuery.post(ajaxurl,c,function(a){try{a=jQuery.parseJSON(a)}catch(c){"undefined"!==typeof console&&null!==console&&console.error("Malformed response",
a);return}return a.error?alert(a.error):b(a)})};f.ajax_request=e;g=new q;g.ajax_request=e;new r({el:a.find(".p2p-connections"),collection:g,candidates:f});new p({el:a.find(".p2p-tab-search"),collection:f,connections:g,spinner:c,duplicate_connections:a.data("duplicate_connections")});new s({el:a.find(".p2p-tab-create-post"),collection:g});new t({el:a,spinner:c,cardinality:a.data("cardinality"),candidates:f,connections:g});return P2PAdmin.boxes[d.p2p_type]={candidates:f,connections:g}})})}).call(this);
